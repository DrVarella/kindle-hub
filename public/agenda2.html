<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Agenda - Hub Kindle</title>
  <link rel="stylesheet" href="style.css" />
  <style>
    .calendar-container { margin: 20px 0; padding: 15px; border: 2px solid #000; background: #fff; }
    .calendar-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
    .calendar-header h2 { font-size: 24px; margin: 0; }
    .calendar-nav { display: flex; gap: 10px; }
    .calendar-nav button { padding: 8px 15px; font-size: 16px; font-weight: bold; cursor: pointer; border: 2px solid #000; background: #fff; }
    .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 2px; margin-bottom: 10px; }
    .calendar-day-header { text-align: center; font-weight: bold; padding: 6px; background: #f0f0f0; border: 1px solid #000; font-size: 12px; }
    .calendar-day { text-align: center; padding: 6px; border: 1px solid #ccc; cursor: pointer; min-height: 30px; background: #fff; font-size: 13px; }
    .calendar-day:hover { background: #f5f5f5; }
    .calendar-day.today { background: #000; color: #fff; font-weight: bold; }
    .calendar-day.selected { background: #666; color: #fff; font-weight: bold; }
    .calendar-day.other-month { color: #ccc; }
    .calendar-day.has-events { font-weight: bold; text-decoration: underline; }
    .week-nav { display: flex; gap: 5px; margin-top: 10px; justify-content: center; }
    .week-day-btn { padding: 8px 12px; font-size: 14px; font-weight: bold; cursor: pointer; border: 2px solid #000; background: #fff; }
    .week-day-btn.active { background: #000; color: #fff; }
    .events-list { margin-top: 20px; }
    .event-item { padding: 12px; border-left: 4px solid #000; margin-bottom: 10px; background: #f9f9f9; }
    .event-time { font-weight: bold; font-size: 14px; color: #666; }
    .event-title { font-size: 18px; margin-top: 4px; }
    .empty-state { color: #666; }
  </style>
</head>
<body>
  <div class="page-container">
    <div class="header">
      <h1>Agenda</h1>
      <a href="index.html" class="back-link">Voltar ao Início</a>
    </div>

    <div class="calendar-container">
      <div class="calendar-header">
        <h2 id="monthYear"></h2>
        <div class="calendar-nav">
          <button onclick="changeMonth(-1)">← Anterior</button>
          <button onclick="goToToday()">Hoje</button>
          <button onclick="changeMonth(1)">Próximo →</button>
        </div>
      </div>

      <div class="calendar-grid" id="calendarGrid"></div>

      <div class="week-nav">
        <button class="week-day-btn" id="btn-0" onclick="selectWeekDay(0)">D 0</button>
        <button class="week-day-btn" id="btn-1" onclick="selectWeekDay(1)">S 1</button>
        <button class="week-day-btn" id="btn-2" onclick="selectWeekDay(2)">T 2</button>
        <button class="week-day-btn" id="btn-3" onclick="selectWeekDay(3)">Q 3</button>
        <button class="week-day-btn" id="btn-4" onclick="selectWeekDay(4)">Q 4</button>
        <button class="week-day-btn" id="btn-5" onclick="selectWeekDay(5)">S 5</button>
        <button class="week-day-btn" id="btn-6" onclick="selectWeekDay(6)">S 6</button>
      </div>
    </div>

    <div class="events-list">
      <h2 id="selectedDateTitle">Eventos</h2>
      <div id="eventsContainer">Carregando eventos...</div>
    </div>
  </div>

  <script>
    // ===== Fuso horário fixo (ignora o fuso do Kindle) =====
    const TZ = 'America/Sao_Paulo';

    // Formatadores no fuso de São Paulo
    const fmtMonthYear = new Intl.DateTimeFormat('pt-BR', { timeZone: TZ, month: 'long', year: 'numeric' });
    const fmtTime = new Intl.DateTimeFormat('pt-BR', { timeZone: TZ, hour: '2-digit', minute: '2-digit' });
    const fmtWeekdayDate = new Intl.DateTimeFormat('pt-BR', { timeZone: TZ, weekday: 'long', day: '2-digit', month: '2-digit', year: 'numeric' });
    const fmtDayNum = new Intl.DateTimeFormat('en-US', { timeZone: TZ, day: '2-digit' });

    // Chave YYYY-MM-DD do dia no fuso de São Paulo (lexicograficamente ordenável)
    function dayKey(dateLike) {
      return new Intl.DateTimeFormat('en-CA', { timeZone: TZ, year: 'numeric', month: '2-digit', day: '2-digit' }).format(new Date(dateLike));
    }
    function keyCompare(a, b) { return a.localeCompare(b); }

    // Retorna true se ev (item do Google Calendar) pertence ao "dia" key (YYYY-MM-DD em TZ)
    function eventBelongsToDay(ev, key) {
      const startLike = ev.start.dateTime || ev.start.date; // .date para all-day (end.date exclusivo)
      const endLike = (ev.end && (ev.end.dateTime || ev.end.date)) || startLike;

      const startHasTime = Boolean(ev.start.dateTime);
      const endHasTime = Boolean(ev.end && ev.end.dateTime);

      const sKey = dayKey(startLike);
      const eKey = dayKey(endLike);

      // All-day pelo padrão do Google: end.date é exclusivo (vai até véspera do end)
      if (!startHasTime && !endHasTime && ev.end && ev.end.date) {
        // Pertence se key ∈ [sKey, eKey)
        return keyCompare(key, sKey) >= 0 && keyCompare(key, eKey) < 0;
      }
      // Eventos com horário: considera inclusivo nas pontas
      return keyCompare(key, sKey) >= 0 && keyCompare(key, eKey) <= 0;
    }

    // ===== Estado =====
    const API_URL = window.location.origin;
    let allEvents = [];
    // currentMonth/selectedDate são Date só para construir grades; comparações usam dayKey(TZ)
    let currentMonth = new Date();
    let selectedDate = new Date();

    const dayLabels = ['D', 'S', 'T', 'Q', 'Q', 'S', 'S'];

    async function loadEvents() {
      try {
        const response = await fetch(`${API_URL}/api/calendar/events?days=30`);
        allEvents = response.ok ? (await response.json()) : [];
      } catch (e) {
        console.error('Erro ao carregar eventos:', e);
        allEvents = [];
      }
      renderCalendar();
      displayEventsForDate(selectedDate);
      updateWeekButtons();
    }

    function renderCalendar() {
      const grid = document.getElementById('calendarGrid');
      const monthYearEl = document.getElementById('monthYear');

      // Mostrar cabeçalho mês/ano em TZ usando o primeiro dia do mês atual
      const year = currentMonth.getFullYear();
      const month = currentMonth.getMonth();
      const headerDate = new Date(year, month, 1);
      monthYearEl.textContent = capitalize(fmtMonthYear.format(headerDate));

      const firstDay = new Date(year, month, 1);
      const lastDay = new Date(year, month + 1, 0);
      const prevLastDay = new Date(year, month, 0);

      const firstDayWeek = firstDay.getDay();
      const lastDate = lastDay.getDate();
      const prevLastDate = prevLastDay.getDate();

      let html = '';

      // Cabeçalhos dos dias
      dayLabels.forEach(d => { html += `<div class="calendar-day-header">${d}</div>`; });

      // Dias do mês anterior
      for (let i = firstDayWeek - 1; i >= 0; i--) {
        html += `<div class="calendar-day other-month">${prevLastDate - i}</div>`;
      }

      const todayKey = dayKey(new Date());
      const selectedKey = dayKey(selectedDate);

      // Dias do mês atual
      for (let day = 1; day <= lastDate; day++) {
        const date = new Date(year, month, day);
        const thisKey = dayKey(date);

        const isToday = thisKey === todayKey;
        const isSelected = thisKey === selectedKey;
        const hasEvents = allEvents.some(e => eventBelongsToDay(e, thisKey));

        let className = 'calendar-day';
        if (isToday) className += ' today';
        if (isSelected) className += ' selected';
        if (hasEvents) className += ' has-events';

        html += `<div class="${className}" onclick="selectDate(${year}, ${month}, ${day})">${day}</div>`;
      }

      // Dias do próximo mês para completar a grade
      const remainingDays = 7 - ((firstDayWeek + lastDate) % 7);
      if (remainingDays < 7) {
        for (let day = 1; day <= remainingDays; day++) {
          html += `<div class="calendar-day other-month">${day}</div>`;
        }
      }

      grid.innerHTML = html;
    }

    function selectDate(year, month, day) {
      selectedDate = new Date(year, month, day);
      renderCalendar();
      displayEventsForDate(selectedDate);
      updateWeekButtons();
    }

    function changeMonth(delta) {
      currentMonth.setMonth(currentMonth.getMonth() + delta);
      renderCalendar();
    }

    function goToToday() {
      const now = new Date();
      currentMonth = new Date(now);
      selectedDate = new Date(now);
      renderCalendar();
      displayEventsForDate(selectedDate);
      updateWeekButtons();
    }

    function selectWeekDay(dayOfWeek) {
      // Semana baseada em domingo (0) no fuso de SP
      const now = new Date();
      const nowDow = new Date(now).getDay();
      let daysToAdd = dayOfWeek - nowDow;
      if (daysToAdd < 0) daysToAdd += 7;
      const targetDate = new Date(now);
      targetDate.setDate(targetDate.getDate() + daysToAdd);

      currentMonth = new Date(targetDate);
      selectedDate = new Date(targetDate);
      renderCalendar();
      displayEventsForDate(selectedDate);
      updateWeekButtons();
    }

    function updateWeekButtons() {
      // Rótulos D/S/T... + número do dia no fuso fixo
      const now = new Date();
      const start = new Date(now);
      start.setDate(now.getDate() - now.getDay()); // domingo
      for (let i = 0; i < 7; i++) {
        const d = new Date(start);
        d.setDate(start.getDate() + i);
        const btn = document.getElementById(`btn-${i}`);
        btn.textContent = `${dayLabels[i]} ${parseInt(fmtDayNum.format(d), 10)}`;
        if (dayKey(d) === dayKey(selectedDate)) btn.classList.add('active');
        else btn.classList.remove('active');
      }
    }

    function displayEventsForDate(date) {
      const container = document.getElementById('eventsContainer');
      const title = document.getElementById('selectedDateTitle');

      // Título "Eventos de segunda, 10/11/2025" em TZ
      const parts = fmtWeekdayDate.formatToParts(date);
      const weekday = capitalize(parts.find(p => p.type === 'weekday')?.value || '');
      const day = parts.find(p => p.type === 'day')?.value || '';
      const month = parts.find(p => p.type === 'month')?.value || '';
      const year = parts.find(p => p.type === 'year')?.value || '';
      title.textContent = `Eventos de ${weekday}, ${day}/${month}/${year}`;

      const key = dayKey(date);
      const dayEvents = allEvents.filter(ev => eventBelongsToDay(ev, key));

      if (dayEvents.length === 0) {
        container.innerHTML = '<p class="empty-state">Nenhum evento para este dia</p>';
        return;
      }

      container.innerHTML = dayEvents.map(event => {
        let timeStr = '';
        if (event.start && event.start.dateTime) {
          const start = event.start.dateTime;
          const end = event.end && event.end.dateTime ? event.end.dateTime : null;
          timeStr = fmtTime.format(new Date(start));
          if (end) timeStr += ' - ' + fmtTime.format(new Date(end));
        } else if (event.start && event.start.date) {
          timeStr = 'Dia inteiro';
        }

        return `
          <div class="event-item">
            ${timeStr ? `<div class="event-time">${timeStr}</div>` : ''}
            <div class="event-title">${escapeHtml(event.summary || 'Sem título')}</div>
            ${event.description ? `<div style="margin-top: 8px; font-size: 14px; color: #666;">${escapeHtml(event.description)}</div>` : ''}
          </div>
        `;
      }).join('');
    }

    // ===== Utilidades =====
    function capitalize(s) { return s ? s.charAt(0).toUpperCase() + s.slice(1) : s; }
    function escapeHtml(str) {
      return String(str)
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#039;');
    }

    // ===== Inicialização =====
    loadEvents();
    updateWeekButtons();
  </script>
</body>
</html>
